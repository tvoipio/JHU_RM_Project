---
title: "Automobile transmission type and fuel mileage"
author: "Timo Voipio"
date: "21 Aug 2016"
output:
    pdf_document:
      latex_engine: xelatex
#mainfont: "texgyretermes-regular.otf"
#mathfont: "texgyretermes-math.otf"
fontsize: 12pt
classoption: a4paper
---

```{r echo=FALSE}
library(knitr)

# TRUE relegates most code chunks to appendices and disables result
# output by default
tidydoc <- FALSE

# figure width 4 inches (PDF output), height = width, center figures
opts_chunk$set(fig.width=4, fig.height=4, fig.align='center')

# Increase the penalty for using scientific notation (to format
# numbers like 10000 normally, not in scientific notation)
options(scipen = 3)

if (tidydoc)
{
    opts_chunk$set(results='hide', echo=FALSE, size='scriptsize')
}
```

# Executive summary

# Introduction

We analyze the fuel consumption of various automobiles from early 1970s in order to determine whether the transmission type, manual or automatic, significantly affects fuel consumption. The dataset is `mtcars` provided by the R `dataset` package, and it consists of mechanical and performance data on 32 different cars from the model years 1973 and 1974.

The aim of the analysis is two answer two questions: is an automatic or manual transmission better for gas mileage (measured in mpg, miles traveled per one US gallon of fuel consumed), and how the gas mileage is quantitatively affected by the transmission type.

# Data description and exploratory analysis

```{r init}

library(datasets)
data("mtcars")

library(ggplot2)
library(GGally)
```

The data consists of design and performance data of `r nrow(mtcars)`, as published in the *Motor Trends* magazine published in the United States in 1974. According to the dataset documentation, the variables in the following table are included. Text in *italics* gives explanatory notes not present in the original data.

Column name | Variable description and units
------------|-------------------------------
`mpg`       | Miles/(US) gallon (*gas mileage; 235 l/100 km = 1/(1 mpg)*)
`cyl`       | Number of cylinders
`disp`      | Displacement (cu.in.) (*1 litre = 61.0 cu in*)
`hp`        | Gross horsepower (*1 kW = 1.34 hp*)
`drat`      | Rear axle ratio (*driveshaft rpm/axle rpm*\footnote{"the drive-axle ratio is a comparison of the number of gear teeth on the ring gear of the rear axle and the pinion gear on the driveshaft. - - For example, a 4.11:1 ratio means there are 4.11 teeth on the axle's ring gear for each tooth on the driveshaft's pinion gear. Or, put another way, the driveshaft must turn 4.11 times to turn the rear wheels one full revolution. - - typical rule of thumb: The higher the numerical ratio, the slower the gear will be. This higher ratio gives a truck greater pulling power, but since the engine must work harder to spin the driveshaft more times for each turn of the rear wheels, top-end speed and fuel economy are sacrificed." From [worktruckonline.com][drat]})
`wt`        | Weight (1000 lbs *= 454 kg*)
`qsec`      | 1/4 mile time
`vs`        | V/S [*V engine (0) or straight (inline) engine (1)*`r #\footnote{Hocking 1971, p.~12}`]
`am`        | Transmission (0 = automatic, 1 = manual)
`gear`      | Number of forward gears
`carb`      | Number of carburetors

The research question stated in the project assignment exclusively asks for analysis of the gas mileage (MPG), so for consistency reasons the data is not converted into SI units, even though the conversion would make the data more accessible to most parts of the world. Additionally, analysing the consumption via the amount of fuel consumed per fixed distance (e.g., litres/100 km) would be both physically and statistically more reasonable choice\footnote{As suggested also by Henderson and Velleman} than gas mileage. However, as the assignment explicitly asks for effect of transmission type on gas mileage, the data will not be converted for analysis. As suggested by Henderson and Velleman, a new variable `pwr` (hp/1000 lbs) is created for the power-to-weight ratio.

```{r explore}

# Convert transmission type, (cylinder count, carburetor count), and engine type
# to factor variables
mtcars$am <- factor(mtcars$am, levels = c(0, 1),
                    labels = c("auto", "manual"))
#mtcars$cyl <- factor(mtcars$cyl)
#mtcars$carb <- factor(mtcars$carb)
mtcars$vs <- factor(mtcars$vs, levels = c(0, 1),
                    labels = c("v", "straight"))

# Create a new variable for gross power/weight ratio
# (hp/1000 lb; 1 hp/1000 lb ≈ 1.64 W/kg)
mtcars$pwr <- mtcars$hp/mtcars$wt

g <- ggplot(mtcars, aes(x = wt, y = mpg))
g <- g + geom_point(aes(color = am))
g <- g + geom_hline(aes(yintercept = mpg, color = am),
                    data = aggregate(mpg ~ am, data = mtcars, mean),
                    linetype = "dashed")
g <- g + ggtitle("Gas mileage vs. weight")

print(g)
```

The plot shows that the mean gas mileage of cars with manual transmission is significantly higher (i.e., better) compared to cars with automatic transmission. However, the plot similarly illustrates that the gas mileage seems to have a clear negative correlation with the weight of the vehicle. We therefore conclude that analyzing at the effect of transmission type on the gas mileage cannot meaningfully be done without adjusting for the effect of other factors affecting the fuel efficiency.

Next we try to isolate the effect of the transmission type by fitting a linear model to the data. This entails also model selection, i.e., which variables best explain the variability of MPG, without overfitting. The dataset contains variables which we would expect to be correlated to at least some degree, such as engine displacement and power, and power-to-weight ratio and quarter-mile time (see the Appendix for a pairs plot).

```{r modelselect}
fitvars <- c("wt", "disp", "pwr", "drat", "am")
resids <- numeric(0)
modelvars <- character(0)
fits <- vector("list", length(fitvars))

# Function for constructing a formula containing the desired variables
fitformula <- function(fitvar, modelvars = NULL, keepvar = NULL) {
    modelstr <- paste("mpg ~", paste(c(keepvar, modelvars, fitvar),
                                     collapse = " + "))
    as.formula(modelstr)
}

# Calculate the deviance resulting from fitting MPG using the listed
# variables as regressors
dev.next <- function(fitvar, modelvars = NULL)
{
    fit <- lm(fitformula(fitvar, modelvars), mtcars)
    deviance(fit)
}

# Iteratively add variables to the model until "am" is one of them
# This may be quite naive approach to automated model selection,
# but it seems to work, after a fashion at least
# "Fit priority selection"
stopifnot("am" %in% fitvars)
while (!("am" %in% modelvars))
{
    # Determine the deviances of the linear models when each of the
    # as of yet unused variables is added
    devs <- sapply(setdiff(fitvars, modelvars),
                   function(fitvar) dev.next(fitvar, modelvars))

        # Choose the variable which results in least deviance
    resids <- c(resids, devs[which.min(devs)])
    modelvars <- c(modelvars, names(which.min(devs)))
    
    # Create a fit involving the chosen variables
    fits[[length(modelvars)]] <- lm(fitformula(modelvars), mtcars)
}

fits <- fits[1:length(modelvars)]

# Call the anova function with the incremental fits
do.call(anova, fits)

```

[drat]: http://www.worktruckonline.com/channel/vehicle-research/article/story/2011/07/10-factors-to-consider-when-spec-ing-drive-axle-ratios-for-medium-duty-trucks.aspx "10 Factors to Consider when Spec’ing Drive-Axle Ratios for Medium-Duty Trucks"

# Sources

 * Hocking (1971) http://www.jstor.org/stable/2529336
 * Henderson and Velleman (1981) http://www.jstor.org/stable/2530428

# Appendix

```{r pairsplot, cache=TRUE, fig.width=12, fig.height=12, out.width="6in", out.height="6in"}

paircols <- c("mpg", "wt", "disp", "hp" ,"qsec", "pwr")
ggpairs(mtcars, aes(color = am),
        columns = match(paircols, names(mtcars)))

```